<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager corner</title>

    <script src="https://cdn.tailwindcss.com"></script>
    

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#4f46e5', // Indigo 600
                            light: '#818cf8',
                            dark: '#3730a3',
                        },
                        secondary: {
                            DEFAULT: '#ec4899', // Pink 500
                            hover: '#db2777',
                        },
                        accent: '#10b981', // Emerald 500
                        surface: '#ffffff',
                        background: '#f3f4f6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'bounce-slight': 'bounceSlight 2s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(-3%)' },
                            '50%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            /* engaging gradient background */
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 50%, #fae8ff 100%);
            min-height: 100vh;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .custom-modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(31, 41, 55, 0.6); /* Darker, blurred overlay */
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 450px;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid #e5e7eb;
        }

        /* Form Inputs Styling */
        input, select {
            border: 2px solid #e2e8f0;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            width: 100%;
            transition: all 0.3s ease;
            background-color: #f8fafc;
            font-size: 0.95rem;
        }

        input:focus, select:focus {
            border-color: #818cf8; /* Primary Light */
            outline: none;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2);
            background-color: #fff;
        }

        /* Custom Alert Styles */
        #custom-alert-modal .modal-content {
            max-width: 400px;
            text-align: center;
            border-top: 6px solid;
        }
        .alert-title-success { color: #10b981; border-color: #10b981; }
        .alert-title-error { color: #ef4444; border-color: #ef4444; }
        .alert-title-warning { color: #f59e0b; border-color: #f59e0b; }
        
        .allocation-form label {
            color: #4b5563;
            font-weight: 600;
            margin-bottom: 6px;
            display: block;
        }

        /* Room Details Modal */
        #room-details-modal .modal-content {
            max-width: 900px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            background: linear-gradient(to bottom right, #ffffff, #f9fafb);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0; 
        }
    </style>
    <style>
/* Hide Google top banner */
.goog-te-banner-frame {
    display: none !important;
}

/* Remove spacing that Google adds to body */
body {
    top: 0px !important;
}

/* Hide the Google toolbar that appears at top */
#goog-gt-tt, .goog-te-balloon-frame, .goog-te-menu-frame {
    display: none !important;
}

/* Prevent full-page grey overlay */
.goog-te-overlay {
    display: none !important;
}

/* Make sure no translation tooltip appears */
.goog-text-highlight {
    background: none !important;
    box-shadow: none !important;
}
</style>

</head>
<body class="font-sans text-gray-700">
    
    <div id="custom-alert-modal" class="custom-modal">
        <div class="modal-content relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gray-200" id="alertBar"></div>
            <div class="mt-4">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
                    <i class="fas fa-bell text-primary text-xl"></i>
                </div>
                <h3 id="alertTitle" class="text-xl font-bold mb-2 text-gray-800">Alert</h3>
                <p id="alertMessage" class="text-gray-600 mb-6 px-4"></p>
            </div>
            <button id="modal-close-btn" class="w-full bg-gradient-to-r from-primary to-primary-dark text-white font-bold py-3 px-4 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                Okay, Got it
            </button>
        </div>
    </div>

    <div id="auth-modal" class="custom-modal">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div class="inline-block p-3 rounded-full bg-indigo-100 text-primary mb-3">
                    <i class="fas fa-user-shield text-2xl"></i>
                </div>
                <h3 id="auth-title" class="text-2xl font-bold text-gray-800">Manager Login</h3>
                <p class="text-sm text-gray-500 mt-1">Secure access for staff only</p>
            </div>
            
            <form id="loginForm" class="mb-4">
                <label for="loginUsername" class="text-sm font-medium mb-1 block text-gray-600">Username</label>
                <input type="text" id="loginUsername" required placeholder="Enter Username" class="focus:ring-primary">
                
                <label for="loginPassword" class="text-sm font-medium mb-1 block text-gray-600">Password</label>
                <input type="password" id="loginPassword" required placeholder="••••••••" class="focus:ring-primary">
                
                <button type="submit" class="w-full bg-gradient-to-r from-primary to-primary-dark text-white font-bold py-3 rounded-xl hover:shadow-lg hover:opacity-90 transition-all mt-4">
                    <i class="fas fa-sign-in-alt mr-2"></i> Login
                </button>
            </form>
            
            <form id="registerForm" class="mb-4 hidden">
                <label for="registerUsername" class="text-sm font-medium mb-1 block text-gray-600">New Username</label>
                <input type="text" id="registerUsername" required placeholder="Choose a Username">
                
                <label for="registerPassword" class="text-sm font-medium mb-1 block text-gray-600">New Password</label>
                <input type="password" id="registerPassword" required placeholder="Create Password">
                
                <button type="submit" class="w-full bg-gradient-to-r from-secondary to-pink-600 text-white font-bold py-3 rounded-xl hover:shadow-lg hover:opacity-90 transition-all mt-4">
                    <i class="fas fa-user-plus mr-2"></i> Create Account
                </button>
            </form>

            <div class="text-center mt-6 pt-4 border-t border-gray-100">
                <button id="toggleAuthBtn" class="text-primary hover:text-primary-dark font-medium text-sm transition-colors">Need an account? Register</button>
            </div>
        </div>
    </div>

    <div id="room-details-modal" class="custom-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b border-gray-100 pb-4 mb-6 sticky top-0 bg-white z-10">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-building text-primary"></i> Room Occupancy
                    </h3>
                    <p class="text-sm text-gray-500">Live view of allocations across all blocks</p>
                </div>
                <button id="room-details-close-btn" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-red-100 hover:text-red-500 transition-colors text-xl">&times;</button>
            </div>
            <div id="roomDetailsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-4">
                <div class="col-span-full flex flex-col items-center justify-center py-10 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin text-4xl mb-3 text-primary"></i>
                    <p>Loading room data...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 lg:p-8 max-w-7xl">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 animate-fade-in">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-primary via-purple-600 to-secondary mb-2">
                    UniStay & Mate Finder
                </h1>
                <p class="text-gray-500 font-medium">Smart Allocation System for Modern Campuses</p>
            </div>
            <button id="managerAuthBtn" class="bg-white text-primary border border-indigo-100 font-bold py-2.5 px-6 rounded-full shadow-sm hover:shadow-md hover:bg-indigo-50 transition-all flex items-center gap-2">
                <i class="fas fa-user-lock"></i> <span>Manager Access</span>
            </button>
        </header>
        
        <div id="managerContent" class="hidden animate-slide-up">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="col-span-1 lg:col-span-4 space-y-8">
                    
                    <div class="glass-panel p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 border-t-4 border-primary">
                        <div class="flex items-center gap-3 mb-5 border-b border-gray-100 pb-3">
                            <div class="bg-indigo-100 p-2 rounded-lg text-primary"><i class="fas fa-door-open"></i></div>
                            <h2 class="text-xl font-bold text-gray-800">Add Room</h2>
                        </div>
                        
                        <form id="roomForm" class="allocation-form">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="roomNumber" class="text-xs uppercase tracking-wide">Room No</label>
                                    <input type="text" id="roomNumber" required placeholder="A-101">
                                </div>
                                <div>
                                    <label for="capacity" class="text-xs uppercase tracking-wide">Capacity</label>
                                    <input type="number" id="capacity" min="1" required value="2">
                                </div>
                            </div>
                            
                            <label for="hostelBlock" class="text-xs uppercase tracking-wide">Block Name</label>
                            <input type="text" id="hostelBlock" required placeholder="Alpha Block">

                            <label for="roomGender" class="text-xs uppercase tracking-wide">Allowed Gender</label>
                            <select id="roomGender" required class="cursor-pointer">
                                <option value="">Select Type</option>
                                <option value="male">Male Only</option>
                                <option value="female">Female Only</option>
                                <option value="mixed">Co-ed / Mixed</option>
                            </select>
                            
                            <button type="submit" class="w-full bg-gradient-to-r from-primary to-primary-dark text-white font-bold py-3 rounded-xl hover:shadow-lg hover:-translate-y-1 transition-all mt-2">
                                <i class="fas fa-plus-circle"></i> Create Room
                            </button>
                        </form>
                    </div>

                    <div class="glass-panel p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 border-t-4 border-secondary">
                        <div class="flex items-center gap-3 mb-5 border-b border-gray-100 pb-3">
                            <div class="bg-pink-100 p-2 rounded-lg text-secondary"><i class="fas fa-cogs"></i></div>
                            <h2 class="text-xl font-bold text-gray-800">System Actions</h2>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-gray-500 mb-2">Process all unallocated students:</p>
                                <button id="runAllocationBtn" class="w-full bg-gradient-to-r from-secondary to-pink-600 text-white font-bold py-3 rounded-xl hover:shadow-lg hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-magic"></i> <span>Auto-Allocate</span>
                                </button>
                                <p id="allocationStatus" class="mt-2 text-center text-sm font-medium h-5"></p>
                            </div>
                            
                            <div class="border-t border-dashed border-gray-300 pt-4">
                                <p class="text-sm text-gray-500 mb-2">Check current status:</p>
                                <button id="viewRoomDetailsBtn" class="w-full bg-white text-gray-700 border-2 border-gray-200 font-bold py-3 rounded-xl hover:bg-gray-50 hover:border-gray-400 transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-list-alt"></i> <span>View Database</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-span-1 lg:col-span-8 space-y-8">
                    
                    <div class="glass-panel p-8 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 bg-white">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-green-100 p-3 rounded-xl text-green-600 text-xl"><i class="fas fa-user-graduate"></i></div>
                            <h2 class="text-2xl font-bold text-gray-800">Student Registration</h2>
                        </div>
                        
                        <form id="studentForm" class="allocation-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label for="studentId" class="text-xs uppercase tracking-wide text-gray-500">Student ID</label>
                                    <input type="text" id="studentId" required placeholder="1CR24C0001" class="bg-gray-50">
                                </div>
                                <div>
                                    <label for="studentName" class="text-xs uppercase tracking-wide text-gray-500">Full Name</label>
                                    <input type="text" id="studentName" required placeholder="John Doe">
                                </div>
                                <div>
                                    <label for="studentGender" class="text-xs uppercase tracking-wide text-gray-500">Gender</label>
                                    <select id="studentGender" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="priority" class="text-xs uppercase tracking-wide text-gray-500">Priority (0 = Highest)</label>
                                    <input type="number" id="priority" min="0" value="0">
                                </div>
                                <div>
                                    <label for="studyTime" class="text-xs uppercase tracking-wide text-gray-500">Preferred Study Time</label>
                                    <select id="studyTime" required>
                                        <option value="">Select Time</option>
                                        <option value="Early Morning">Early Morning (5 AM - 9 AM)</option>
                                        <option value="Day">Day (9 AM - 5 PM)</option>
                                        <option value="Evening">Evening (5 PM - 10 PM)</option>
                                        <option value="Night">Night Owl (10 PM+)</option>
                                        <option value="Flexible">Flexible</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="hobbies" class="text-xs uppercase tracking-wide text-gray-500">Hobbies (Max 5)</label>
                                    <input type="text" id="hobbies" required placeholder="coding, gaming, music...">
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 rounded-xl hover:shadow-lg hover:-translate-y-1 transition-all mt-6 flex justify-center items-center gap-2">
                                <i class="fas fa-check-circle"></i> Register Student
                            </button>
                        </form>
                    </div>

                    <div class="glass-panel p-8 rounded-2xl shadow-lg bg-gradient-to-br from-white to-indigo-50">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-indigo-100 pb-4">
                            <div class="flex items-center gap-3 mb-4 md:mb-0">
                                <div class="bg-purple-100 p-3 rounded-xl text-purple-600 text-xl"><i class="fas fa-search-location"></i></div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800">Find Your Mate</h2>
                                    <p class="text-sm text-gray-500">Algorithm-based matching</p>
                                </div>
                            </div>
                            
                            <form id="mateFinderForm" class="flex w-full md:w-auto gap-2">
                                <input type="text" id="mateStudentId" required placeholder="Student ID" class="mb-0 w-full md:w-48 bg-white">
                                <button type="submit" class="bg-primary text-white px-6 py-2 rounded-xl hover:bg-primary-dark transition-colors shadow-md">
                                    <i class="fas fa-search"></i>
                                </button>
                            </form>
                        </div>

                        <div id="mateResultsSection">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Potential Matches (<span id="matchCount" class="text-primary">0</span>)</h3>
                            <div id="mateResultsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 min-h-[100px]">
                                <div class="col-span-full flex flex-col items-center justify-center text-gray-400 py-8 border-2 border-dashed border-gray-200 rounded-xl">
                                    <i class="fas fa-user-friends text-4xl mb-2 opacity-30"></i>
                                    <p>Enter an ID above to find compatible roommates.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="guestContent" class="flex flex-col items-center justify-center py-20 text-center animate-fade-in">
            <div class="glass-panel p-10 rounded-3xl shadow-2xl max-w-2xl w-full bg-white/60">
                <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg animate-bounce-slight">
                    <i class="fas fa-lock text-4xl text-white"></i>
                </div>
                <h2 class="text-3xl font-extrabold text-gray-800 mb-4">Access Restricted</h2>
                <p class="text-lg text-gray-600 mb-8 leading-relaxed">
                    Welcome to the Room Allocation System. Please log in as a <b>Manager</b> to access administrative features, register students, and run the allocation algorithms.
                </p>
                <button onclick="document.getElementById('auth-modal').style.display = 'flex'" class="bg-gradient-to-r from-primary to-purple-600 text-white text-lg font-bold py-4 px-10 rounded-full shadow-xl hover:shadow-2xl hover:scale-105 transition-all duration-300">
                    <i class="fas fa-key mr-2"></i> Open Manager Portal
                </button>
            </div>
        </div>

    </div>

    <footer class="text-center text-gray-400 text-sm py-8 mt-8">
        <p>&copy; 2025 UniStay System. Built with <i class="fas fa-heart text-red-400 mx-1"></i> for Campus Life.</p>
    </footer>

    <script>
        const BACKEND_URL = 'http://localhost:3000'; 
        let studentMap = new Map();
        let isManagerLoggedIn = false;

        // --- Custom Alert Modal Logic ---
        const alertModal = document.getElementById('custom-alert-modal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const alertBar = document.getElementById('alertBar');

        function customAlert(message, title = 'Notification', type = 'Success') {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            
            // Reset classes
            alertTitle.className = 'text-xl font-bold mb-2';
            alertBar.className = 'absolute top-0 left-0 w-full h-2';

            if (type.toLowerCase().includes('success') || type.toLowerCase().includes('login')) {
                alertTitle.classList.add('text-green-600');
                alertBar.classList.add('bg-green-500');
            } else if (type.toLowerCase().includes('error') || type.toLowerCase().includes('denied') || type.toLowerCase().includes('failed')) {
                alertTitle.classList.add('text-red-600');
                alertBar.classList.add('bg-red-500');
            } else {
                alertTitle.classList.add('text-yellow-500');
                alertBar.classList.add('bg-yellow-500');
            }

            alertModal.style.display = 'flex';
        }

        modalCloseBtn.addEventListener('click', () => {
            alertModal.style.display = 'none';
        });

        // --- Manager Authentication Logic ---
        const authModal = document.getElementById('auth-modal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleAuthBtn = document.getElementById('toggleAuthBtn');
        const managerContent = document.getElementById('managerContent');
        const guestContent = document.getElementById('guestContent');
        const managerAuthBtn = document.getElementById('managerAuthBtn');

        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                authModal.style.display = 'none';
            }
        });

        toggleAuthBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const isLoginView = !loginForm.classList.contains('hidden');
            loginForm.classList.toggle('hidden');
            registerForm.classList.toggle('hidden');
            document.getElementById('auth-title').textContent = isLoginView ? 'Manager Registration' : 'Manager Login';
            toggleAuthBtn.textContent = isLoginView ? 'Already have an account? Login' : 'Need an account? Register';
        });

        function setManagerUI(isLoggedIn) {
            isManagerLoggedIn = isLoggedIn;
            managerContent.classList.toggle('hidden', !isLoggedIn);
            guestContent.classList.toggle('hidden', isLoggedIn);
            
            if (isLoggedIn) {
                managerAuthBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> <span>Logout</span>';
                managerAuthBtn.classList.add('bg-red-50', 'text-red-600', 'border-red-100');
                managerAuthBtn.classList.remove('bg-white', 'text-primary');
            } else {
                managerAuthBtn.innerHTML = '<i class="fas fa-user-lock"></i> <span>Manager Access</span>';
                managerAuthBtn.classList.remove('bg-red-50', 'text-red-600', 'border-red-100');
                managerAuthBtn.classList.add('bg-white', 'text-primary');
            }
            
            authModal.style.display = 'none'; 
        }

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/manager/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Registration failed.');
                }
                
                customAlert('Manager registered successfully. Please log in.', 'Success');
                document.getElementById('toggleAuthBtn').click(); 
            } catch (error) {
                customAlert(`Registration failed: ${error.message}`, 'Error');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/manager/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Login failed.');
                }
                
                sessionStorage.setItem('managerToken', result.token);
                customAlert('Welcome back, Manager!', 'Login Success');
                setManagerUI(true);

            } catch (error) {
                customAlert(`Login failed: ${error.message}`, 'Error');
                setManagerUI(false);
            }
        });

        managerAuthBtn.addEventListener('click', () => {
            if (isManagerLoggedIn) {
                sessionStorage.removeItem('managerToken');
                setManagerUI(false);
                customAlert('You have been logged out.', 'Logout');
                initializeData();
            } else {
                authModal.style.display = 'flex';
            }
        });
        // --- END Authentication Logic ---


        // --- Core Data Handling & Fetching ---
        async function fetchStudents() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/students`);
                if (!response.ok) throw new Error('Failed to fetch students.');
                const students = await response.json();
                studentMap = new Map(students.map(s => [s.id, s]));
                console.log('Students data loaded.');
                return students;
            } catch (error) {
                console.error('Error fetching students:', error);
                return []; 
            }
        }
        
        async function initializeData() {
             await fetchStudents();
        }


        // --- Room Management Logic ---
        async function addRoom(e) {
            e.preventDefault();
            if (!isManagerLoggedIn) return customAlert('You must be logged in as a Manager to add rooms.', 'Access Denied', 'Error');

            const roomData = {
                roomNumber: document.getElementById('roomNumber').value.trim(),
                capacity: parseInt(document.getElementById('capacity').value),
                gender: document.getElementById('roomGender').value,
                hostelBlock: document.getElementById('hostelBlock').value.trim(),
            };

            try {
                const response = await fetch(`${BACKEND_URL}/api/rooms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(roomData)
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to add room.');
                }

                customAlert(`Room ${result.roomNumber} (Capacity: ${result.capacity}) added successfully!`, 'Room Added', 'Success');
                document.getElementById('roomForm').reset();
            } catch (error) {
                customAlert(`Failed to add room: ${error.message}`, 'Error');
            }
        }
        
        async function runAllocation() {
            if (!isManagerLoggedIn) return customAlert('You must be logged in as a Manager to run allocation.', 'Access Denied', 'Error');

            const statusElement = document.getElementById('allocationStatus');
            statusElement.innerHTML = '<span class="flex items-center justify-center gap-2 text-indigo-600"><i class="fas fa-circle-notch fa-spin"></i> Running allocation...</span>';

            try {
                const response = await fetch(`${BACKEND_URL}/api/allocate`, { method: 'POST' });
                const result = await response.json();

                if (!response.ok) {
                    if (response.status === 400 && result.message.includes('Insufficient rooms')) {
                        customAlert(result.message, 'Allocation Failed', 'Error');
                        statusElement.innerHTML = '<span class="text-red-500 font-bold"><i class="fas fa-times-circle"></i> Insufficient Rooms</span>';
                        return; 
                    }
                    throw new Error(result.message || 'Allocation failed on server.');
                }

                statusElement.innerHTML = `<span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> Allocated ${result.allocated}/${result.totalProcessed}</span>`;
                customAlert(statusElement.textContent, 'Allocation Success', 'Success');
                await initializeData(); 

            } catch (error) {
                statusElement.innerHTML = '<span class="text-red-500 font-bold">Server Error</span>';
                customAlert(`Allocation failed: ${error.message}`, 'Error');
            }
        }

        // --- Student Registration ---
        async function addStudent() {
            if (!isManagerLoggedIn) return customAlert('You must be logged in as a Manager to register students.', 'Access Denied', 'Error');

            const hobbiesInput = document.getElementById('hobbies').value.trim();
            const hobbiesArray = hobbiesInput.split(',').map(h => h.trim()).filter(h => h.length > 0);
            
            if (hobbiesArray.length > 5) {
                 return customAlert('Please enter a maximum of 5 hobbies.', 'Validation Error', 'Warning');
            }
            if (hobbiesArray.length < 1) {
                 return customAlert('Please enter at least one hobby.', 'Validation Error', 'Warning');
            }


            const studentData = {
                id: document.getElementById('studentId').value.trim(),
                name: document.getElementById('studentName').value.trim(),
                gender: document.getElementById('studentGender').value,
                priority: parseInt(document.getElementById('priority').value),
                studyTime: document.getElementById('studyTime').value,
                hobbies: hobbiesArray 
            };
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/students`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to add student.');
                }
                
                customAlert(`Student ${result.name} (${result.id}) registered successfully!`, 'Student Added', 'Success');
                document.getElementById('studentForm').reset();
                await initializeData();

            } catch (error) {
                customAlert(`Failed to register student: ${error.message}`, 'Error');
            }
        }

        // --- Mate Finder Logic ---
        async function findMates(e) {
            e.preventDefault();
            if (!isManagerLoggedIn) return customAlert('You must be logged in as a Manager to use the Mate Finder.', 'Access Denied', 'Error');
            
            const studentId = document.getElementById('mateStudentId').value.trim();
            const container = document.getElementById('mateResultsContainer');
            const countSpan = document.getElementById('matchCount');
            
            container.innerHTML = `<p class="text-primary col-span-full text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Crunching the data...</p>`;

            try {
                const response = await fetch(`${BACKEND_URL}/api/findmate/${studentId}`);
                const candidates = await response.json();
                
                if (!response.ok) {
                    throw new Error(candidates.message || 'Could not fetch candidates.');
                }

                container.innerHTML = ''; 
                countSpan.textContent = candidates.length;

                if (candidates.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-6 bg-gray-50 rounded-xl border border-gray-200">
                            <i class="fas fa-ghost text-3xl text-gray-300 mb-2"></i>
                            <p class="text-gray-500 font-medium">No matches found for ${studentId}.</p>
                        </div>`;
                    customAlert(`No mates found for Student ID: ${studentId}.`, 'No Matches', 'Warning');
                } else {
                    candidates.forEach(mate => {
                        const scoreColor = mate.score >= 80 ? 'text-green-500' : (mate.score >= 50 ? 'text-yellow-500' : 'text-gray-400');
                        
                        const card = document.createElement('div');
                        card.className = 'bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-gray-100 relative overflow-hidden';
                        card.innerHTML = `
                            <div class="absolute top-0 right-0 bg-gray-100 rounded-bl-xl px-3 py-1 text-xs font-bold text-gray-500">ID: ${mate.id}</div>
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white text-lg font-bold shadow-md">
                                    ${mate.name.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 leading-tight">${mate.name}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="text-sm font-bold ${scoreColor}">
                                            <i class="fas fa-star"></i> ${mate.score.toFixed(0)}% Match
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 space-y-2 text-sm">
                                <div class="flex items-center gap-2 text-gray-600">
                                    <i class="fas fa-clock w-5 text-center text-indigo-400"></i> 
                                    <span>${mate.studyTime}</span>
                                </div>
                                <div class="flex items-start gap-2 text-gray-600">
                                    <i class="fas fa-gamepad w-5 text-center mt-1 text-pink-400"></i> 
                                    <span class="italic">${mate.hobbies.join(', ')}</span>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }

            } catch (error) {
                console.error('Mate Finder Error:', error);
                countSpan.textContent = 'Error';
                container.innerHTML = `<p class="text-red-500 font-bold col-span-full text-center bg-red-50 p-4 rounded-lg">Search failed: ${error.message}</p>`;
                customAlert(`Mate search failed: ${error.message}`, 'Mate Finder Error', 'Error');
            }
        }
        
        // --- Room Details Logic (UPDATED) ---

        const roomDetailsModal = document.getElementById('room-details-modal');
        const roomDetailsContainer = document.getElementById('roomDetailsContainer');
        const viewRoomDetailsBtn = document.getElementById('viewRoomDetailsBtn');
        const roomDetailsCloseBtn = document.getElementById('room-details-close-btn');

        roomDetailsCloseBtn.addEventListener('click', () => {
            roomDetailsModal.style.display = 'none';
        });

        roomDetailsModal.addEventListener('click', (e) => {
            if (e.target === roomDetailsModal) {
                roomDetailsModal.style.display = 'none';
            }
        });

        // NEW: Function to handle Unallocate
        async function unallocateStudent(studentId, roomNumber) {
            if (!confirm(`Are you sure you want to UNALLOCATE student ${studentId} from room ${roomNumber}? This cannot be undone easily.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/students/unallocate/${studentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to unallocate student.');
                }

                customAlert(result.message, 'Unallocation Success', 'Success');
                // Refresh the room details view
                await viewRoomDetails(); 
                await initializeData();

            } catch (error) {
                customAlert(`Unallocation failed: ${error.message}`, 'Error');
            }
        }

        // NEW: Function to handle Delete
        async function deleteStudent(studentId) {
            if (!confirm(`WARNING: Are you sure you want to PERMANENTLY DELETE student ${studentId}? This action cannot be reversed.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/students/${studentId}`, {
                    method: 'DELETE',
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to delete student.');
                }

                customAlert(result.message, 'Student Deleted', 'Success');
                // Refresh the room details view
                await viewRoomDetails(); 
                await initializeData();

            } catch (error) {
                customAlert(`Deletion failed: ${error.message}`, 'Error');
            }
        }


        async function viewRoomDetails() {
            if (!isManagerLoggedIn) return customAlert('You must be logged in as a Manager to view room details.', 'Access Denied', 'Error');

            roomDetailsModal.style.display = 'flex';
            roomDetailsContainer.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-10 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin text-4xl mb-3 text-primary"></i>
                    <p>Fetching room and occupant data...</p>
                </div>`;

            try {
                const response = await fetch(`${BACKEND_URL}/api/room-details`);
                const roomData = await response.json();

                if (!response.ok) {
                    throw new Error(roomData.message || 'Failed to fetch room details.');
                }
                
                roomDetailsContainer.innerHTML = '';

                if (roomData.length === 0) {
                    roomDetailsContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 font-semibold py-10">No rooms found in the database.</p>`;
                    return;
                }

                roomData.forEach(room => {
                    const occupancy = room.currentOccupants;
                    const capacity = room.capacity;
                    const isFull = occupancy === capacity;
                    
                    // Visual indicator color
                    let statusColor = 'bg-green-100 text-green-700 border-green-200';
                    if (isFull) statusColor = 'bg-red-100 text-red-700 border-red-200';
                    else if (occupancy > 0) statusColor = 'bg-blue-100 text-blue-700 border-blue-200';

                    let occupantListHTML = room.occupants.map(
                        student => `
                        <li class="flex items-center justify-between bg-gray-50 p-2 rounded mb-1 text-sm">
                            <div class="flex flex-col">
                                <span class="font-medium text-gray-700">${student.name}</span>
                                <span class="text-xs text-gray-400">ID: ${student.id}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="unallocateStudent('${student.id}', '${room.roomNumber}')" class="text-xs text-blue-500 hover:text-blue-700 bg-white px-2 py-1 rounded border border-blue-200 hover:bg-blue-50 transition-colors" title="Remove student from this room">
                                    <i class="fas fa-undo"></i> Unallocate
                                </button>
                                <button onclick="deleteStudent('${student.id}')" class="text-xs text-red-500 hover:text-red-700 bg-white px-2 py-1 rounded border border-red-200 hover:bg-red-50 transition-colors" title="Permanently delete student record">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                        </li>`
                    ).join('');

                    if (occupancy === 0) {
                        occupantListHTML = '<li class="text-sm text-gray-400 italic text-center py-2">Room is currently empty</li>';
                    }

                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-all';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="text-xl font-bold text-gray-800">${room.roomNumber}</h4>
                                <p class="text-xs text-gray-500 uppercase tracking-wider">${room.hostelBlock}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-bold border ${statusColor}">
                                ${occupancy} / ${capacity}
                            </span>
                        </div>
                        
                        <div class="mb-3 flex gap-2">
                             <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded capitalize"><i class="fas fa-venus-mars"></i> ${room.gender}</span>
                        </div>

                        <div class="border-t pt-3 mt-2">
                            <p class="text-xs font-semibold text-gray-400 mb-2 uppercase">Occupants</p>
                            <ul class="">
                                ${occupantListHTML}
                            </ul>
                        </div>
                    `;
                    roomDetailsContainer.appendChild(card);
                });

            } catch (error) {
                roomDetailsContainer.innerHTML = `<p class="col-span-full text-center text-red-500 font-bold py-10">Error: ${error.message}</p>`;
            }
        }


        // 4. INITIALIZATION & Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('managerToken')) {
                setManagerUI(true);
            } else {
                setManagerUI(false);
            }
            
            initializeData();
            
            document.getElementById('studentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addStudent();
            });

            document.getElementById('roomForm').addEventListener('submit', addRoom);
            
            document.getElementById('runAllocationBtn').addEventListener('click', runAllocation);

            document.getElementById('mateFinderForm').addEventListener('submit', findMates);

            // NEW: Room Details Button Listener
            document.getElementById('viewRoomDetailsBtn').addEventListener('click', viewRoomDetails);
        });
    </script>
    <!-- Google Translate (hidden UI) -->
<div id="google_translate_element" style="display:none;"></div>

<script>
function setCookie(name, value, days) {
  var expires = "";
  if (days) {
    var date = new Date();
    date.setTime(date.getTime() + days*24*60*60*1000);
    expires = "; expires=" + date.toUTCString();
  }
  document.cookie = name + "=" + (value || "") + expires + "; path=/";
}

function applySavedLanguage(lang) {
  if (!lang) return;
  var trans = "/en/" + lang;
  setCookie("googtrans", trans, 365);
  setCookie("googtrans", trans, 365);
}

function initGoogleTranslate() {
  new google.translate.TranslateElement(
    { pageLanguage: "en", autoDisplay: false },
    "google_translate_element"
  );

  var tries = 0;
  var poll = setInterval(function () {
    var combo = document.querySelector(".goog-te-combo");
    if (combo || tries > 25) {
      clearInterval(poll);

      var saved = localStorage.getItem("selectedLang") || "";
      if (saved && combo) {
        setTimeout(function () {
          combo.value = saved;
          combo.dispatchEvent(new Event("change"));
        }, 300);
      }
    }
    tries++;
  }, 200);
}

(function () {
  var s = document.createElement("script");
  s.src =
    "//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
  s.async = true;
  document.head.appendChild(s);
  window.googleTranslateElementInit = initGoogleTranslate;

  var existing = localStorage.getItem("selectedLang");
  if (existing) applySavedLanguage(existing);
})();
</script>

</body>
</html>
